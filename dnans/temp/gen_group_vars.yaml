- name: Ensure group_vars/all.yaml contains required values
  block:
    - name: Load existing all.yaml
      slurp:
        src: group_vars/all.yaml
      register: all_vars
      ignore_errors: true

    - name: Parse all.yaml content if exists
      set_fact:
        existing_vars: "{{ all_vars['content'] | b64decode | from_yaml }}"
      when: all_vars is defined and all_vars.content != ''

    - name: Initialize default group_vars content
      set_fact:
        default_vars:
          project_path: "{{ ansible_env.HOME }}/snand"
          # Add other defaults here...

    - name: Update group_vars/all.yaml with missing values
      copy:
        dest: group_vars/all.yaml
        content: "{{ (existing_vars | default({})) | combine(default_vars, recursive=True) | to_nice_yaml }}"
        mode: '0644'
      when: existing_vars is not defined or existing_vars != default_vars

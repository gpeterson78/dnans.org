---
# Check if the vault.yaml file exists
- name: Check if vault.yaml exists
  stat:
    path: "vault.yaml"
  register: vault_file

# Create vault.yaml from template if it does not exist
- name: Create vault.yaml from template if missing
  template:
    src: "{{ role_path }}/templates/vault.yaml.j2"
    dest: "vault.yaml"
  when: not vault_file.stat.exists

# Prompt user to update vault if necessary
- name: Prompt user to edit vault.yaml
  pause:
    prompt: "Vault needs updates. Edit now? (Y/N)"
  register: user_input

# Fail if the user opts not to edit
- name: Error out if user declines to edit vault.yaml
  fail:
    msg: >-
      Vault updates are required. Exiting as the user opted not to edit.
  when: user_input.user_input | lower != 'y'

# Invoke ansible-vault edit
- name: Open vault.yaml for editing
  ansible.builtin.command:
    cmd: ansible-vault edit vault.yaml

# Encrypt vault.yaml after edits
- name: Encrypt vault.yaml
  ansible.builtin.command:
    cmd: ansible-vault encrypt vault.yaml
  when: vault_file.stat.exists
